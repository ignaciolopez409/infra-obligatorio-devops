name: DeployIaC
on:
  push:
    branches:
      - main
jobs:
  SETUP:
    runs-on: ubuntu-latest
    if: "contains(github.event.head_commit.message, '[CD]')"
    steps:
      - uses: actions/checkout@v2
      - id: setup
        env:
          AWS_CREDENTIALS: ${{secrets.AWS_CREDENTIALS}}
          REGION: us-east-1
        run: |
          COMMIT_MSG="${{github.event.head_commit.message}}"
          DEST_ENV=$(echo "$COMMIT_MSG" | cut -d"|" -f2 | sed -e 's/^[ \t]*//')
          ##
          mkdir ~/.aws
          echo "$AWS_CREDENTIALS" > ~/.aws/credentials
          aws s3api create-bucket --bucket "$DEST_ENV-states" --region $REGION --acl private
          aws dynamodb create-table \
              --region "$REGION" \
              --table-name "$DEST_ENV-lock" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --provisioned-throughput ReadCapacityUnits=20,WriteCapacityUnits=20 \
              --tags Key=Name,Value="DynamoDB Terraform State Lock Table" 2>/dev/null || echo "Tabla existente"
          echo "##[set-output name=DEST_ENV;]$(echo $DEST_ENV)"
    outputs:
      DEST_ENV: ${{ steps.setup.outputs.DEST_ENV }}
  DEPLOY_INFRA:
    runs-on: ubuntu-latest
    needs: ["SETUP"]
    steps:
      - uses: actions/checkout@v2
      - name: Run Terraform
        env:
          AWS_CREDENTIALS: ${{secrets.AWS_CREDENTIALS}}
        run: |
          DEST_ENV=${{ needs.SETUP.outputs.DEST_ENV }}
          ##
          mkdir ~/.aws
          echo "$AWS_CREDENTIALS" > ~/.aws/credentials
          FULL_PATH=$(pwd) && cd manifest_cluster
          cp -sr $FULL_PATH/environments/$DEST_ENV/** .
          rm -rf app_bucket.tf
          terraform init --reconfigure -input=false
          terraform apply --auto-approve  -var-file=config.tfvars
  DEPLOY_APPS:
    runs-on: ubuntu-latest
    needs: ['DEPLOY_INFRA', "SETUP"]
    steps:
      - uses: actions/checkout@v2
      - env:
          AWS_CREDENTIALS: ${{secrets.AWS_CREDENTIALS}}
        run: |
          DEST_ENV=${{ needs.SETUP.outputs.DEST_ENV }}
          ##
          mkdir ~/.aws
          echo "$AWS_CREDENTIALS" > ~/.aws/credentials
          FULL_PATH=$(pwd) && cd manifest_applications
          cp -sr $FULL_PATH/environments/$DEST_ENV/** .
          rm -rf bucket.tf
          terraform init --reconfigure -input=false
          terraform apply --auto-approve -var-file=config.tfvars
  TEST_AUTOMATION:
    runs-on: ubuntu-latest
    needs: ["DEPLOY_APPS", "SETUP"]
    steps:
      - uses: actions/checkout@v2
      - name: Run Terraform
        env:
          AWS_CREDENTIALS: ${{ secrets.AWS_CREDENTIALS }}
        run: |
          DEST_ENV=${{ needs.SETUP.outputs.DEST_ENV }}
          ##
          mkdir ~/.aws
          echo "$AWS_CREDENTIALS" > ~/.aws/credentials
          FULL_PATH=$(pwd) && cd manifest_applications
          cp -sr $FULL_PATH/environments/$DEST_ENV/** .
          rm -rf bucket.tf
          terraform init --reconfigure -input=false
          URL=$(terraform output endpoint_out -raw)
          cd karate
          ./mvnw clean test -Durl=$URL -Dkarate.env=${DEST_ENV} "-Dkarate.options=--tags @regression"